<!DOCTYPE html>
<html>
<head>
  <title>Wyrdbox Chat</title>
  <link rel="stylesheet" href="style.css">

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1>Wyrdbox Chat</h1>

  <div id="chat-container">
    <!-- Left: Chat window -->
    <div id="chat-section">
      <input id="nickname" disabled>
      <div id="chatbox"></div>

      <div id="input-row">
        <input id="message" placeholder="Type a message">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>

    <!-- Right: User list -->
    <div id="user-section">
      <input id="userSearch" placeholder="Search users...">
      <ul id="userList"></ul>
    </div>
  </div>

  <script>
    // Firebase setup
    firebase.initializeApp({
      apiKey: "AIzaSyCqILLxx2JAxstJ9LRIiqgFDWUTvAx4ZVs",
      authDomain: "chatbox-3c95d.firebaseapp.com",
      projectId: "chatbox-3c95d",
      storageBucket: "chatbox-3c95d.firebasestorage.app",
      messagingSenderId: "385714577506",
      appId: "1:385714577506:web:9308dc98ed8de92d00713b"
    });

    const db = firebase.firestore();

    // Determine user
    let nickname = sessionStorage.getItem('nickname');
    if (!nickname) window.location.href = 'welcome.html';
    document.getElementById('nickname').value = nickname;

    // Current chat mode (global or DM with someone)
    let currentChat = { type: "global", user: null };

    // Daily GMT-6 reset for global chat only
    const now = new Date();
    const nowGMT6 = new Date(now.getTime() - (6 * 60 + now.getTimezoneOffset()) * 60000);
    const todayKey = nowGMT6.toISOString().split('T')[0];
    const lastReset = localStorage.getItem('lastReset');
    if (lastReset !== todayKey) {
      db.collection("messages").get().then(snapshot => {
        snapshot.forEach(doc => db.collection("messages").doc(doc.id).delete());
      });
      localStorage.setItem('lastReset', todayKey);
    }

    // Send message
    function sendMessage() {
      const msg = document.getElementById('message').value;
      if (msg.trim() === "") return;

    if (currentChat.type === "global") {
        db.collection("messages").add({
          nickname: nickname,
          text: msg,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      } else {
        const chatId = [nickname, currentChat.user].sort().join("_");
        db.collection("dms").doc(chatId).collection("messages").add({
          from: nickname,
          to: currentChat.user,
          text: msg,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      document.getElementById('message').value = "";
    }

    // Display chat messages
    function loadChat() {
      const chatbox = document.getElementById("chatbox");
      chatbox.innerHTML = "";

      if (currentChat.unsubscribe) currentChat.unsubscribe();

      if (currentChat.type === "global") {
        currentChat.unsubscribe = db.collection("messages").orderBy("timestamp")
          .onSnapshot(snapshot => {
            chatbox.innerHTML = "";
            snapshot.forEach(doc => {
              const data = doc.data();
              chatbox.innerHTML += `<p><strong>${data.nickname}:</strong> ${data.text}</p>`;
            });
            chatbox.scrollTop = chatbox.scrollHeight;
          });
      } else {
        const chatId = [nickname, currentChat.user].sort().join("_");
        currentChat.unsubscribe = db.collection("dms").doc(chatId).collection("messages").orderBy("timestamp")
          .onSnapshot(snapshot => {
            chatbox.innerHTML = "";
            snapshot.forEach(doc => {
              const data = doc.data();
              chatbox.innerHTML += `<p><strong>${data.from}:</strong> ${data.text}</p>`;
            });
            chatbox.scrollTop = chatbox.scrollHeight;
          });
      }
    }

    loadChat();

    // Registered users (simple: anyone who signed up gets stored in "users")
    db.collection("users").onSnapshot(snapshot => {
      const userList = document.getElementById("userList");
      const search = document.getElementById("userSearch").value.toLowerCase();
      userList.innerHTML = "";
      snapshot.forEach(doc => {
        const user = doc.data().nickname;
        if (user !== nickname && user.toLowerCase().includes(search)) {
          const li = document.createElement("li");
          li.textContent = user;
          li.onclick = () => {
            currentChat = { type: "dm", user: user };
            loadChat();
          };
          userList.appendChild(li);
        }
      });
    });

    // User search
    document.getElementById("userSearch").addEventListener("input", () => {
      db.collection("users").get().then(() => {}); // refresh by re-rendering
    });

    // Save self to "users" collection
    db.collection("users").doc(nickname).set({ nickname: nickname }, { merge: true });
  </script>
</body>
</html>
